# 更新日志

本文档记录"电老虎测试"项目的所有功能开发和版本更新。

---

## [v1.3.0] - 2025-11-21

### ✨ 新增功能

#### 智能备份提醒 ⭐
自动提醒用户定期备份数据，防止意外丢失宝贵的骑行记录。

##### 核心特性
- **自动计数**：系统自动跟踪新增记录数量
- **智能提醒**：每新增20条记录时自动弹出备份提醒
- **快速备份**：提醒对话框提供"立即备份"按钮，一键导出 JSON 备份
- **稍后提醒**：可选择延后，下次新增20条记录时再次提醒
- **计数重置**：导出备份后自动重置计数器
- **数据持久化**：备份计数信息保存在 localStorage，刷新页面不丢失

##### 技术实现
- 在 Pinia store 中添加 `lastBackupCount` 状态
- `addRecord` 函数返回备份检查结果
- `checkBackupReminder()` 判断是否需要提醒
- `resetBackupCounter()` 在备份后重置计数
- Entry.vue 中集成提醒对话框
- Settings.vue 支持路由参数 `?action=export` 自动触发导出

##### 用户体验提升
- **无打扰设计**：只在保存新记录后提醒，不影响日常使用
- **一键操作**：点击"立即备份"直接跳转到设置页面并自动下载备份
- **明确反馈**：提示框显示新增记录数和总记录数
- **灵活选择**：用户可以选择立即备份或稍后提醒

#### PWA 离线支持 ⭐
实现完整的渐进式 Web 应用（PWA）功能，支持离线使用和安装到桌面。

##### 核心特性
- **Service Worker 自动注册**：使用 vite-plugin-pwa 自动生成和管理 Service Worker
- **离线可用**：应用首次访问后，即使断网也能继续使用
- **智能缓存策略**：
  - 图片资源：CacheFirst 策略，缓存 30 天
  - 字体文件：CacheFirst 策略，缓存 1 年
  - CDN 资源：CacheFirst 策略，缓存 30 天
- **自动更新**：每小时检查一次更新，有新版本时提示用户
- **安装到桌面**：
  - iOS：Safari 浏览器点击分享按钮，选择"添加到主屏幕"
  - Android：Chrome 浏览器会自动提示"安装应用"
  - 桌面端：Chrome/Edge 地址栏会显示安装图标

##### 技术实现
- **vite-plugin-pwa**: 基于 Workbox 的 PWA 插件
- **manifest.json**: 完整的应用清单文件
- **图标资源**: 192x192 和 512x512 两种尺寸
- **更新策略**: autoUpdate 模式，自动下载并提示更新

##### 用户体验提升
- 首次加载后资源缓存，二次打开速度极快
- 弱网环境下也能流畅使用
- 像原生应用一样安装和启动
- 断网情况下依然可以查看已有数据

#### 能耗趋势分析系统
全新的智能趋势分析功能，帮助你深入理解骑行能耗变化规律。

##### 1. 能耗趋势图表
- **双折线对比**：
  - 紫色线：实际能耗数据（每次骑行的真实能耗）
  - 绿色渐变线：移动平均趋势（平滑的整体趋势）
- **智能时间轴**：显示"月/日 时:分"格式，避免同一天多条记录显示重复
- **自适应移动平均算法**：
  - 数据充足时使用7天窗口（更平滑）
  - 数据较少时自动调整为3-4天窗口（避免失真）
  - 最少3条记录即可开始分析
- **渐变填充效果**：视觉化展示趋势走向
- **交互提示**：鼠标悬停显示详细数值

##### 2. 改善分析卡片
- **最近7天数据汇总**：
  - 平均能耗：显示近期整体水平
  - 趋势标识：改善中✨ / 稳定👌 / 需注意⚠️
  - 变化百分比：与之前7天对比，量化改善效果
  - 最佳记录：显示最省电的一次骑行及时间
- **动态背景色**：根据趋势状态（改善/恶化/稳定）自动变换渐变背景
- **智能判断**：
  - 变化 < -2%：显示为"改善中"（绿色）
  - 变化 > +2%：显示为"需注意"（橙色）
  - 其他：显示为"稳定"（蓝色）

##### 3. 路况智能推荐
- **按标签分组**：为每种路况（平路/上坡/市区/高速等）单独推荐最优配置
- **推荐卡片内容**：
  - 路况标签名称
  - 最优母线/相线电流配置
  - 最低能耗值
  - 理论续航
  - 该标签平均能耗
  - 样本数量（至少3次记录才推荐）
- **自动排序**：按样本数量排序，数据越多越可信
- **渐变卡片设计**：美观的网格布局 + 入场动画

### 🎨 界面优化

#### 图表页面布局调整
- 新增第4个Tab标签"能耗趋势"
- 优化图表标题和图例间距，避免文字拥挤
- 调整网格布局，为标题和图例预留更多空间
- 统一深色模式适配

### 🔧 技术改进

#### 算法优化
- **自适应窗口算法**：
  ```javascript
  窗口大小 = min(7, max(3, floor(数据量/2)))
  ```
  - 确保移动平均在任何数据量下都能正确工作
  - 前期数据点使用累积平均，后期使用滑动窗口

#### 代码结构
- 新增 `calculateMovingAverage()` 函数：通用的移动平均计算
- 新增 `consumptionTrendData` 计算属性：趋势图表数据
- 新增 `improvementAnalysis` 计算属性：改善分析数据
- 新增 `configRecommendationsByTag` 计算属性：智能推荐数据
- 新增 `initConsumptionTrendChart()` 函数：图表初始化

### 💡 使用场景

1. **评估调教效果**：
   - 修改电流配置后，观察绿色趋势线是否下降
   - 趋势线持续下降 = 调教成功 ✅

2. **发现异常波动**：
   - 紫色线某次突然飙高，可能是特殊路况或载重
   - 绿色线保持平稳，说明整体性能稳定

3. **路况优化建议**：
   - 查看每种路况的最优配置推荐
   - 对比不同标签的能耗差异
   - 为常用路况创建专属模板

4. **长期趋势追踪**：
   - 观察电池老化对能耗的影响
   - 评估季节变化（温度）对性能的影响

### 🐛 问题修复

- 修复能耗趋势图X轴日期重复显示问题
- 修复移动平均在少量数据时计算错误
- 修复图表标题和图例重叠问题
- 优化图表网格布局，提升可读性

---

## [v1.2.0] - 2025-11-20

### ✨ 新增功能

#### 1. 快速录入模板系统
- 支持将常用的母线/相线电流配置保存为模板
- 模板管理：保存、应用、命名
- 在录入页面一键应用已保存的模板
- 模板数据持久化存储，下次使用时仍可用
- **使用场景**：省电模式、运动模式、通勤模式等不同配置快速切换

#### 2. 电费计算功能
- 在设置页面新增电价配置（元/kWh），默认 0.6 元
- 每条骑行记录自动计算电费成本
- 记录卡片显示电费（金币图标 + 金额）
- 统计卡片（今日/本周/本月）新增电费总计
- Excel 导出包含电费列
- **价值**：直观了解骑行成本，评估不同配置的经济性

#### 3. 日期范围筛选功能
- 5种筛选模式：
  - 全部：显示所有记录
  - 今日：仅显示今天的记录
  - 近7天：显示最近一周的记录
  - 近30天：显示最近一个月的记录
  - 自定义：通过日历选择任意日期范围
- 支持与路况标签筛选组合使用
- 筛选条件实时生效，无需刷新页面
- **使用场景**：查看特定时期的骑行数据，进行对比分析

#### 4. 记录对比功能
- 点击"对比"按钮进入对比模式
- 支持选择任意2条记录进行详细对比
- 选择第2条记录后自动弹出对比窗口
- 对比内容包括：
  - 日期时间
  - 母线/相线电流（高亮显示）
  - 行驶里程
  - 能耗（高亮显示）
  - 理论续航（高亮显示）
  - 电费（高亮显示）
- 中间列显示差值，颜色标识：
  - 绿色：表示第2条记录在该项上更优
  - 红色：表示第2条记录在该项上更差
- **价值**：直观对比不同电流配置的性能差异，找出最优设置

### 🎨 界面优化

#### SOC 消耗徽章
- 在记录卡片右下角添加 SOC 消耗百分比徽章
- 渐变背景 + 毛玻璃效果
- 电池图标 + 数值显示
- 悬停动画效果

#### 温度字段标签优化
- 将"电机最高温"改为"电机温度"
- 将"控制器最高温"改为"控制器温度"
- 标签更简洁、更符合实际使用

### 📊 数据分析增强

#### 温度影响图表升级
- 支持同时显示电机温度和控制器温度
- 双系列散点图：
  - 蓝色点：电机温度 vs 能耗
  - 橙色点：控制器温度 vs 能耗
- 独立渐变色配色方案
- 图例和布局优化，避免重叠

#### 母线电流效率图表升级为气泡图
- 从柱状图升级为散点气泡图
- 三维数据展示：
  - X 轴：母线限流（A）
  - Y 轴：能耗（Wh/km）
  - 气泡大小：相线限流（80-200A 映射到 15-35px）
- 每个数据点都是独立记录，不再是分组平均
- 气泡颜色基于能耗等级（优秀/正常/警告）
- 渐变填充效果，视觉更丰富
- **价值**：直观展示母线、相线、能耗三者关系，快速找出最优组合

### 🐛 问题修复

- 修复 SOC 徽章定位问题
- 修复温度图表标题和图例重叠问题
- 修复阈值滑块不可调节问题（改回输入框）
- 优化对比按钮被底部导航遮挡问题（改为自动弹窗）

### 🔧 技术改进

- 所有计算函数支持电价参数传递
- 图表配置增加深色模式适配
- 优化数据过滤逻辑，支持多条件组合
- 代码结构优化，提高可维护性

---

## [v1.1.0] - 2025-11-19

### 📊 图表可视化系统

#### 母线电流效率分析图表
- 柱状图展示不同母线电流下的平均能耗
- 自动分组统计
- 渐变色彩基于能耗等级

#### 温度影响分析图表
- 散点图分析电机温度对能耗的影响
- 帮助发现过热问题

#### 续航趋势图表
- 折线图追踪理论续航的时间变化
- 填充渐变效果

#### 最省电配置推荐
- 自动计算能耗最低的记录
- 展示对应的电流配置和续航
- 推荐卡片醒目显示

### 🎨 视觉设计升级

- 渐变色彩系统（基于能耗等级）
- 毛玻璃效果导航栏
- 卡片入场动画
- 深色模式支持

### 📱 统计功能

- 今日/本周/本月数据统计卡片
- 显示骑行次数、总里程、平均能耗
- 横向滚动浏览

---

## [v1.0.0] - 2025-11-18

### 🎉 首次发布

#### 核心功能

##### 数据录入
- 支持录入母线/相线电流限制
- 记录行驶里程和电量消耗
- 可选记录电机温度
- 支持添加路况标签（预设 + 自定义）
- 支持添加备注信息
- 日期时间选择器

##### 自动计算
- 消耗能量（Wh）
- 平均能耗（Wh/km）
- 理论满电续航（km）
- 能耗等级评估（优秀/正常/警告）

##### 记录管理
- 记录列表展示
- 滑动删除记录
- 点击编辑记录
- 下拉刷新
- 空状态提示

##### 设置功能
- 电池参数配置（电压、容量）
- 能耗阈值配置（优秀、警告）
- 自定义路况标签管理
- 深色模式切换

##### 数据导出
- 导出为 Excel 表格
- 导出/导入 JSON 备份
- 清空所有记录（带确认）

#### 技术架构

- Vue 3 + Vite + Pinia
- Vant 4 移动端 UI 组件库
- ECharts 5 图表库
- LocalStorage 数据持久化
- SheetJS Excel 导出

---

## 版本说明

### 版本号规则

采用语义化版本号 `MAJOR.MINOR.PATCH`：

- **MAJOR（主版本号）**：重大架构变更或不兼容的API修改
- **MINOR（次版本号）**：新增功能，向下兼容
- **PATCH（修订号）**：Bug修复和小优化

### 开发计划

#### 待开发功能（v1.4.0 规划）

- [x] 能耗趋势分析（已完成于 v1.3.0）
- [x] PWA 支持（已完成于 v1.3.0）
- [ ] 天气数据关联
- [ ] 数据云同步（可选）
- [ ] 分享功能（生成图片/链接）
- [ ] 更多图表类型（箱型图、热力图等）
- [ ] AI 推荐最优配置
- [ ] 骑行轨迹记录（可选）
- [ ] 多车辆管理
- [ ] 数据统计报表

#### 性能优化计划

- [x] PWA 离线缓存（已完成于 v1.3.0）
- [ ] 虚拟滚动优化长列表
- [ ] 图表懒加载
- [ ] Service Worker 缓存策略优化

---

## 反馈与贡献

如果你在使用过程中发现问题或有新的功能建议，欢迎：

- 提交 Issue
- 发起 Pull Request
- 联系开发者

感谢你的使用和支持！ 🎉
